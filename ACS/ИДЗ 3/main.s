.include "macrolib.s"
.include "macrolib-dialog-boxes.s"
.include "macrolib-files.s"
.include "consts.s"

.data
    	buffer: .space 10240          # §¢§å§æ§Ö§â §Õ§Ý§ñ §ç§â§Ñ§ß§Ö§ß§Ú§ñ §ä§Ö§Ü§ã§ä§Ñ (10 §Ü§Ò§Ñ§Û§ä = 10 * 1024 §Ò§Ñ§Û§ä)
    	number_buffer: .space 8        # §¢§å§æ§Ö§â §Õ§Ý§ñ §ç§â§Ñ§ß§Ö§ß§Ú§ñ §é§Ú§ã§Ý§Ñ §Ó §Ó§Ú§Õ§Ö §ã§ä§â§à§Ü§Ú
    	msg_input_file: .asciz "§£§Ó§Ö§Õ§Ú§ä§Ö §ß§Ñ§Ù§Ó§Ñ§ß§Ú§Ö §Ó§ç§à§Õ§ß§à§Ô§à §æ§Ñ§Û§Ý§Ñ: "
    	msg_output_file: .asciz "§£§Ó§Ö§Õ§Ú§ä§Ö §ß§Ñ§Ù§Ó§Ñ§ß§Ú§Ö §Ó§í§ç§à§Õ§ß§à§Ô§à §æ§Ñ§Û§Ý§Ñ: "
    	msg_enter_N: .asciz "§£§Ó§Ö§Õ§Ú§ä§Ö §é§Ú§ã§Ý§à N: "
    	msg_error: .asciz "§±§â§à§Ú§Ù§à§ê§Ý§Ñ §à§ê§Ú§Ò§Ü§Ñ §á§â§Ú §â§Ñ§Ò§à§ä§Ö §ã §æ§Ñ§Û§Ý§à§Þ\n"
    	msg_Yes_No: .asciz "§£§í§Ó§Ö§ã§ä§Ú §á§à§Ý§å§é§Ö§ß§ß§í§Ö §Õ§Ñ§ß§ß§í§Ö §Ó §Ü§à§ß§ã§à§Ý§î?"

.text
.global main

main:
    	# §£§Ó§à§Õ §ß§Ñ§Ù§Ó§Ñ§ß§Ú§ñ §Ó§ç§à§Õ§ß§à§Ô§à §æ§Ñ§Û§Ý§Ñ
    	input_string_dialog(msg_input_file, buffer, PATH_SIZE)
    	mv a0 a1           	# §£§à§Ù§Ó§â§Ñ§ä §Ñ§Õ§â§Ö§ã§Ñ §Ò§å§æ§Ö§â§Ñ §Ó §â§Ö§Ô§Ú§ã§ä§â a0
    	li a1 100

    	# §µ§Õ§Ñ§Ý§ñ§Ö§Þ §ã§Ú§Þ§Ó§à§Ý §ß§à§Ó§à§Û §ã§ä§â§à§Ü§Ú §Ú§Ù §ß§Ñ§Ù§Ó§Ñ§ß§Ú§ñ §Ó§ç§à§Õ§ß§à§Ô§à §æ§Ñ§Û§Ý§Ñ
    	la t0 buffer
    	remove_newline t0

	# §°§ä§Ü§â§í§Ó§Ñ§Ö§Þ §Ó§ç§à§Õ§ß§à§Û §æ§Ñ§Û§Ý §Õ§Ý§ñ §é§ä§Ö§ß§Ú§ñ
	open(buffer, READ_ONLY)
    	
    	# §±§â§à§Ó§Ö§â§ñ§Ö§Þ §å§ã§á§Ö§ê§ß§à§ã§ä§î §à§ä§Ü§â§í§ä§Ú§ñ §Ó§ç§à§Õ§ß§à§Ô§à §æ§Ñ§Û§Ý§Ñ
    	li t0 -1
    	beq a0 t0 error_exit

    	# §³§à§ç§â§Ñ§ß§ñ§Ö§Þ §Õ§Ö§ã§Ü§â§Ú§á§ä§à§â §Ó§ç§à§Õ§ß§à§Ô§à §æ§Ñ§Û§Ý§Ñ
    	mv s0 a0

    	# §£§Ó§à§Õ §ß§Ñ§Ù§Ó§Ñ§ß§Ú§ñ §Ó§í§ç§à§Õ§ß§à§Ô§à §æ§Ñ§Û§Ý§Ñ
    	input_string_dialog(msg_output_file, buffer, PATH_SIZE)

    	# §µ§Õ§Ñ§Ý§ñ§Ö§Þ §ã§Ú§Þ§Ó§à§Ý §ß§à§Ó§à§Û §ã§ä§â§à§Ü§Ú §Ú§Ù §ß§Ñ§Ù§Ó§Ñ§ß§Ú§ñ §Ó§í§ç§à§Õ§ß§à§Ô§à §æ§Ñ§Û§Ý§Ñ
    	la t0 buffer
    	remove_newline t0

    	# §°§ä§Ü§â§í§Ó§Ñ§Ö§Þ §Ó§í§ç§à§Õ§ß§à§Û §æ§Ñ§Û§Ý
    	open(buffer, WRITE_ONLY)

    	# §±§â§à§Ó§Ö§â§ñ§Ö§Þ §å§ã§á§Ö§ê§ß§à§ã§ä§î §à§ä§Ü§â§í§ä§Ú§ñ §Ó§í§ç§à§Õ§ß§à§Ô§à §æ§Ñ§Û§Ý§Ñ
    	li t0 -1
    	beq a0 t0 error_exit

    	# §³§à§ç§â§Ñ§ß§ñ§Ö§Þ §Õ§Ö§ã§Ü§â§Ú§á§ä§à§â §Ó§í§ç§à§Õ§ß§à§Ô§à §æ§Ñ§Û§Ý§Ñ
    	mv s1 a0

    	# §£§Ó§à§Õ §é§Ú§ã§Ý§Ñ N
    	input_string_dialog(msg_enter_N, number_buffer, NUMBER_SIZE)
    	mv a0 a1           	# §£§à§Ù§Ó§â§Ñ§ä §Ñ§Õ§â§Ö§ã§Ñ §Ò§å§æ§Ö§â§Ñ §Ó §â§Ö§Ô§Ú§ã§ä§â a0
    	li a1 100

    	# §µ§Õ§Ñ§Ý§ñ§Ö§Þ §ã§Ú§Þ§Ó§à§Ý §ß§à§Ó§à§Û §ã§ä§â§à§Ü§Ú §Ú§Ù §á§à§Õ§ã§ä§â§à§Ü§Ú
    	la t0 number_buffer
    	remove_newline(t0)
    	
    	# §¬§à§ß§Ó§Ö§â§ä§Ú§â§å§Ö§Þ §ã§ä§â§à§Ü§å §Ó §é§Ú§ã§Ý§à
    	la t4 number_buffer
    	string_to_int(t4, s10)

    	# §£§í§Ò§à§â Yes/No §Õ§Ý§ñ §Ó§í§Ó§à§Õ§Ñ §Õ§Ñ§ß§ß§í§ç §Ó §Ü§à§ß§ã§à§Ý§î
    	mv a1 a0
    	confirm_dialog(msg_Yes_No)
    	mv s11 a0           	# §±§Ö§â§Ö§ß§à§ã§Ú§Þ §Ó§í§Ò§à§â §á§à§Ý§î§Ù§à§Ó§Ñ§ä§Ö§Ý§ñ §Ó §â§Ö§Ô§Ú§ã§ä§â s11
    	mv a0 a1           	# §£§à§Ù§Ó§â§Ñ§ä §Ñ§Õ§â§Ö§ã§Ñ §Ò§å§æ§Ö§â§Ñ §Ó §â§Ö§Ô§Ú§ã§ä§â a0

    	# §ª§ß§Ú§è§Ú§Ñ§Ý§Ú§Ù§Ú§â§å§Ö§Þ §ã§é§Ö§ä§é§Ú§Ü§Ú
    	li s2 0            	# §°§Ò§ë§Ú§Û §ã§é§Ö§ä§é§Ú§Ü §á§â§à§é§Ú§ä§Ñ§ß§ß§í§ç §Ò§Ñ§Û§ä
    	li s3 0            	# §³§Þ§Ö§ë§Ö§ß§Ú§Ö §Ó §Ò§å§æ§Ö§â§Ö
    	li t6 10240        	# §®§Ñ§Ü§ã§Ú§Þ§Ñ§Ý§î§ß§í§Û §â§Ñ§Ù§Þ§Ö§â §æ§Ñ§Û§Ý§Ñ (10 §¬§¢)

read_loop:
    	# §£§í§é§Ú§ã§Ý§ñ§Ö§Þ §Ü§à§Ý§Ú§é§Ö§ã§ä§Ó§à §à§ã§ä§Ñ§Ó§ê§Ú§ç§ã§ñ §Ò§Ñ§Û§ä §Õ§Ý§ñ §é§ä§Ö§ß§Ú§ñ
    	li t0 10240
    	sub t0 t0 s2      	# t0 = 10240 - s2 (§à§ã§ä§Ñ§Ó§ê§Ú§Ö§ã§ñ §Ò§Ñ§Û§ä§í)

    	# t0 == 0 => §Õ§à§ã§ä§Ú§Ô§ß§å§ä §Þ§Ñ§Ü§ã§Ú§Þ§Ñ§Ý§î§ß§í§Û §â§Ñ§Ù§Þ§Ö§â, §Ù§Ñ§Ó§Ö§â§ê§Ñ§Ö§Þ §é§ä§Ö§ß§Ú§Ö
    	beq t0 zero end_read_loop

    	# §°§á§â§Ö§Õ§Ö§Ý§ñ§Ö§Þ, §ã§Ü§à§Ý§î§Ü§à §Ò§Ñ§Û§ä §é§Ú§ä§Ñ§ä§î §Ó §ä§Ö§Ü§å§ë§Ö§Û §Ú§ä§Ö§â§Ñ§è§Ú§Ú
    	li t1 512
    	blt t0 t1 set_bytes_to_read
    	mv t2 t1         	# bytes_to_read = 512
    	j update_values
set_bytes_to_read:
    	mv t2 t0         	# bytes_to_read = §à§ã§ä§Ñ§Ó§ê§Ú§Ö§ã§ñ §Ò§Ñ§Û§ä§í
update_values:
    	# §µ§ã§ä§Ñ§ß§Ñ§Ó§Ý§Ú§Ó§Ñ§Ö§Þ §Ñ§Õ§â§Ö§ã §Ù§Ñ§á§Ú§ã§Ú §Ó §Ò§å§æ§Ö§â §ã §å§é§Ö§ä§à§Þ §ã§Þ§Ö§ë§Ö§ß§Ú§ñ
    	la t3 buffer
    	add a1 t3 s3      	# a1 = buffer + s3

    	# §µ§ã§ä§Ñ§ß§Ñ§Ó§Ý§Ú§Ó§Ñ§Ö§Þ §Ü§à§Ý§Ú§é§Ö§ã§ä§Ó§à §Ò§Ñ§Û§ä §Õ§Ý§ñ §é§ä§Ö§ß§Ú§ñ
    	mv a2 t2         	# a2 = bytes_to_read

	# §¹§Ú§ä§Ñ§Ö§Þ
	read(s0, a1, a2)

    	# §±§â§à§Ó§Ö§â§ñ§Ö§Þ §ß§Ñ §à§ê§Ú§Ò§Ü§Ú §é§ä§Ö§ß§Ú§ñ
    	blt a0 zero error_exit

    	# §¦§ã§Ý§Ú a0 == 0, §Õ§à§ã§ä§Ú§Ô§ß§å§ä §Ü§à§ß§Ö§è §æ§Ñ§Û§Ý§Ñ
    	beq a0 zero end_read_loop

    	# §°§Ò§ß§à§Ó§Ý§ñ§Ö§Þ §ã§é§Ö§ä§é§Ú§Ü§Ú
    	add s2 s2 a0      	# s2 = s2 + a0 (§à§Ò§ë§Ö§Ö §Ü§à§Ý§Ú§é§Ö§ã§ä§Ó§à §á§â§à§é§Ú§ä§Ñ§ß§ß§í§ç §Ò§Ñ§Û§ä)
    	add s3 s3 a0      	# s3 = s3 + a0 (§ã§Þ§Ö§ë§Ö§ß§Ú§Ö §Ó §Ò§å§æ§Ö§â§Ö)

    	# §±§Ö§â§Ö§ç§à§Õ§Ú§Þ §Ü §ã§Ý§Ö§Õ§å§ð§ë§Ö§Û §Ú§ä§Ö§â§Ñ§è§Ú§Ú
    	j read_loop

end_read_loop:
    	# §£§í§Ù§í§Ó§Ñ§Ö§Þ §á§à§Õ§á§â§à§Ô§â§Ñ§Þ§Þ§å §á§à§Ú§ã§Ü§Ñ §á§à§Õ§ã§ä§â§à§Ü§Ú
    	la a0 buffer            # §¡§Õ§â§Ö§ã §ä§Ö§Ü§ã§ä§Ñ
    	mv a1 s2             	# §¥§Ý§Ú§ß§Ñ §ä§Ö§Ü§ã§ä§Ñ
    	mv a2 s10		# N
    	mv a3 s1             	# §¥§Ö§ã§Ü§â§Ú§á§ä§à§â §Ó§í§ç§à§Õ§ß§à§Ô§à §æ§Ñ§Û§Ý§Ñ
    	mv a4 s11		# §£§í§Ò§à§â Yes/No (0 / 1)
    	jal ra find_last_symbols

    	# §©§Ñ§Ü§â§í§Ó§Ñ§Ö§Þ §æ§Ñ§Û§Ý§í
    	close(s0)
    	close(s1)
    	exit

error_exit:
    	# §£§í§Ó§à§Õ§Ú§Þ §ã§à§à§Ò§ë§Ö§ß§Ú§Ö §à§Ò §à§ê§Ú§Ò§Ü§Ö §Ú §Ù§Ñ§Ó§Ö§â§ê§Ñ§Ö§Þ §á§â§à§Ô§â§Ñ§Þ§Þ§å
    	message_dialog(msg_error, 0)
    	exit