.include "macrolib.s"
.include "macrolib-dialog-boxes.s"
.include "macrolib-files.s"
.include "consts.s"

.global remove_newline
.global find_last_symbols
.global input_string_dialog
.global message_dialog
.global confirm_dialog

# §±§à§Õ§á§â§à§Ô§â§Ñ§Þ§Þ§Ñ §Õ§Ý§ñ §à§ä§à§Ò§â§Ñ§Ø§Ö§ß§Ú§ñ §ã§à§à§Ò§ë§Ö§ß§Ú§ñ §á§à§Ý§î§Ù§à§Ó§Ñ§ä§Ö§Ý§ð §Ú §Ó§Ó§à§Õ§Ñ §ã§ä§â§à§Ü§Ú
# §±§Ñ§â§Ñ§Þ§Ö§ä§â§í:
#    a0 - §Ñ§Õ§â§Ö§ã §ã§ä§â§à§Ü§Ú §ã§à§à§Ò§ë§Ö§ß§Ú§ñ §Õ§Ý§ñ §á§à§Ý§î§Ù§à§Ó§Ñ§ä§Ö§Ý§ñ (null-terminated)
#    a1 - §Ñ§Õ§â§Ö§ã §Ò§å§æ§Ö§â§Ñ §Õ§Ý§ñ §Ó§Ó§à§Õ§Ñ
#    a2 - §Þ§Ñ§Ü§ã§Ú§Þ§Ñ§Ý§î§ß§à§Ö §Ü§à§Ý§Ú§é§Ö§ã§ä§Ó§à §ã§Ú§Þ§Ó§à§Ý§à§Ó §Õ§Ý§ñ §é§ä§Ö§ß§Ú§ñ (§Ó§Ü§Ý§ð§é§Ñ§ñ §Ù§Ñ§Ó§Ö§â§ê§Ñ§ð§ë§Ú§Û null)
# §£§à§Ù§Ó§â§Ñ§ë§Ñ§Ö§Þ§à§Ö §Ù§ß§Ñ§é§Ö§ß§Ú§Ö:
#    a1 - §Ò§å§æ§Ö§â §ã§à§Õ§Ö§â§Ø§Ú§ä §Ó§Ó§Ö§Õ§×§ß§ß§å§ð §ã§ä§â§à§Ü§å (§Þ§Ñ§Ü§ã§Ú§Þ§å§Þ §Õ§à§á§å§ã§ä§Ú§Þ§í§ç §ã§Ú§Þ§Ó§à§Ý§à§Ó, §Ù§Ñ§Ó§Ö§â§ê§Ñ§Ö§ä§ã§ñ null)
input_string_dialog:
    push(ra)                  # §³§à§ç§â§Ñ§ß§ñ§Ö§Þ §Ñ§Õ§â§Ö§ã §Ó§à§Ù§Ó§â§Ñ§ä§Ñ §ß§Ñ §ã§ä§Ö§Ü§Ö

    li a7 54                  # §³§Ú§ã§ä§Ö§Þ§ß§í§Û §Ó§í§Ù§à§Ó §Õ§Ý§ñ §Ó§Ó§à§Õ§Ñ §ã§ä§â§à§Ü§Ú
    ecall                    

    pop(ra)                   
    jr ra                    
    	
# Service to display a message to user
# §±§à§Õ§á§â§à§Ô§â§Ñ§Þ§Þ§Ñ §Õ§Ý§ñ §à§ä§à§Ò§â§Ñ§Ø§Ö§ß§Ú§ñ §ã§à§à§Ò§ë§Ö§ß§Ú§ñ §á§à§Ý§î§Ù§à§Ó§Ñ§ä§Ö§Ý§ð
# §±§Ñ§â§Ñ§Þ§Ö§ä§â§í:
#    a0 - §Ñ§Õ§â§Ö§ã §ã§ä§â§à§Ü§Ú §ã§à§à§Ò§ë§Ö§ß§Ú§ñ, §Ü§à§ä§à§â§à§Ö §Ò§å§Õ§Ö§ä §à§ä§à§Ò§â§Ñ§Ø§Ö§ß§à §á§à§Ý§î§Ù§à§Ó§Ñ§ä§Ö§Ý§ð (null-terminated)
#    a1 - the type of the message to the user, which is one of: 
#	0: error message
#	1: information message 
#	2: warning message 
#	3: question message 
#	other: plain message
# §£§à§Ù§Ó§â§Ñ§ë§Ñ§Ö§Þ§à§Ö §Ù§ß§Ñ§é§Ö§ß§Ú§Ö:
#    §¯§Ö§ä
message_dialog:
	# §³§à§ç§â§Ñ§ß§ñ§Ö§Þ §Ñ§Õ§â§Ö§ã §Ó§à§Ù§Ó§â§Ñ§ä§Ñ §ß§Ñ §ã§ä§Ö§Ü§Ö	
    	push(ra)

    	# §£§í§Ù§í§Ó§Ñ§Ö§Þ §Õ§Ú§Ñ§Ý§à§Ô§à§Ó§à§Ö §à§Ü§ß§à
    	li a7 55
    	ecall

    	# §©§Ñ§Ò§Ú§â§Ñ§Ö§Þ §Ñ§Õ§â§Ö§ã §Ó§à§Ù§Ó§â§Ñ§ä§Ñ §ã§à §ã§ä§Ö§Ü§Ñ §Ú §Ó§à§Ù§Ó§â§Ñ§ë§Ñ§Ö§Þ
    	pop(ra)
    	jr ra
    	
# Service to display a message to user
# §±§Ñ§â§Ñ§Þ§Ö§ä§â§í:
#    a0 - address of null-terminated string that is the message to user
# §£§à§Ù§Ó§â§Ñ§ë§Ñ§Ö§Þ§à§Ö §Ù§ß§Ñ§é§Ö§ß§Ú§Ö:
#    a0 = Yes (0), No (1), or Cancel(2)
confirm_dialog:
	# §³§à§ç§â§Ñ§ß§ñ§Ö§Þ §Ñ§Õ§â§Ö§ã §Ó§à§Ù§Ó§â§Ñ§ä§Ñ §ß§Ñ §ã§ä§Ö§Ü§Ö	
    	push(ra)

    	# §£§í§Ù§í§Ó§Ñ§Ö§Þ §Õ§Ú§Ñ§Ý§à§Ô§à§Ó§à§Ö §à§Ü§ß§à
    	li a7 50
    	ecall

    	# §©§Ñ§Ò§Ú§â§Ñ§Ö§Þ §Ñ§Õ§â§Ö§ã §Ó§à§Ù§Ó§â§Ñ§ä§Ñ §ã§à §ã§ä§Ö§Ü§Ñ §Ú §Ó§à§Ù§Ó§â§Ñ§ë§Ñ§Ö§Þ
    	pop(ra)
    	jr ra

# §±§à§Õ§á§â§à§Ô§â§Ñ§Þ§Þ§Ñ §å§Õ§Ñ§Ý§Ö§ß§Ú§ñ §ã§Ú§Þ§Ó§à§Ý§Ñ §ß§à§Ó§à§Û §ã§ä§â§à§Ü§Ú
# §±§Ñ§â§Ñ§Þ§Ö§ä§â§í:
#    4(sp) - §Ñ§Õ§â§Ö§ã §ã§ä§â§à§Ü§Ú
# §£§à§Ù§Ó§â§Ñ§ë§Ñ§Ö§Þ§à§Ö §Ù§ß§Ñ§é§Ö§ß§Ú§Ö: 
#    §¯§Ö§ä
remove_newline:
	push(ra)
	
	# §£§à§ã§ã§ä§Ñ§ß§Ñ§Ó§Ý§Ú§Ó§Ñ§Ö§Þ §Ù§ß§Ñ§é§Ö§ß§Ú§Ö §Ñ§Õ§â§Ö§ã§Ñ §ã§ä§â§à§Ü§Ú §Ú§Ù §ã§ä§Ö§Ü§Ñ
	lw t1 4(sp)
remove_newline_loop:
    	lb t2 (t1)
    	beqz t2 remove_newline_end
    	li t3 10  	# §¬§à§Õ §ã§Ú§Þ§Ó§à§Ý§Ñ §ß§à§Ó§à§Û §ã§ä§â§à§Ü§Ú
    	beq t2 t3 remove_newline_found
    	addi t1 t1 1
    	j remove_newline_loop
remove_newline_found:
    	sb zero (t1)
remove_newline_end:
    	pop(ra)
    	jr ra 		# §£§í§ç§à§Õ§Ú§Þ §Ú§Ù §á§à§Õ§á§â§à§Ô§â§Ñ§Þ§Þ§í

# §±§à§Õ§á§â§à§Ô§â§Ñ§Þ§Þ§Ñ §Õ§Ý§ñ §Ù§Ñ§á§Ú§ã§Ú §á§à§ã§Ý§Ö§Õ§ß§Ú§ç N §ã§Ú§Þ§Ó§à§Ý§à§Ó §ã§ä§â§à§Ü§Ú §Ó §æ§Ñ§Û§Ý
# §±§Ñ§â§Ñ§Þ§Ö§ä§â§í:
#    a0 - §Ñ§Õ§â§Ö§ã §ä§Ö§Ü§ã§ä§Ñ
#    a1 - §Õ§Ý§Ú§ß§Ñ §ä§Ö§Ü§ã§ä§Ñ
#    a2 - N (§Ü§à§Ý§Ú§é§Ö§ã§ä§Ó§à §ã§Ú§Þ§Ó§à§Ý§à§Ó)
#    a3 - §Õ§Ö§ã§Ü§â§Ú§á§ä§à§â §Ó§í§ç§à§Õ§ß§à§Ô§à §æ§Ñ§Û§Ý§Ñ
# §£§à§Ù§Ó§â§Ñ§ë§Ñ§Ö§Þ§à§Ö §Ù§ß§Ñ§é§Ö§ß§Ú§Ö:
#    §¯§Ö§ä
find_last_symbols:
    push(ra)                 # §³§à§ç§â§Ñ§ß§Ö§ß§Ú§Ö §Ñ§Õ§â§Ö§ã§Ñ §Ó§à§Ù§Ó§â§Ñ§ä§Ñ

    mv s3 a0                # §¡§Õ§â§Ö§ã §ä§Ö§Ü§ã§ä§Ñ
    mv s4 a1                # §¥§Ý§Ú§ß§Ñ §ä§Ö§Ü§ã§ä§Ñ
    mv s5 a2                # N (§Ü§à§Ý§Ú§é§Ö§ã§ä§Ó§à §ã§Ú§Þ§Ó§à§Ý§à§Ó §Õ§Ý§ñ §Ù§Ñ§á§Ú§ã§Ú)
    mv s8 a3                # §¥§Ö§ã§Ü§â§Ú§á§ä§à§â §Ó§í§ç§à§Õ§ß§à§Ô§à §æ§Ñ§Û§Ý§Ñ
    mv s7 a4		   # §£§í§Ò§à§â Yes/No (0 / 1)

    blt s4 s5 use_full_text # §¦§ã§Ý§Ú N > §Õ§Ý§Ú§ß§í §ã§ä§â§à§Ü§Ú, §Ù§Ñ§á§Ú§ã§Ñ§ä§î §Ó§ã§ð §ã§ä§â§à§Ü§å

    sub s6 s4 s5            # §¯§Ñ§é§Ñ§Ý§î§ß§í§Û §Ú§ß§Õ§Ö§Ü§ã: §Õ§Ý§Ú§ß§Ñ - N
    add s3 s3 s6            # §µ§Ü§Ñ§Ù§Ñ§ä§Ö§Ý§î = §ß§Ñ§é§Ñ§Ý§à §á§à§ã§Ý§Ö§Õ§ß§Ú§ç N §ã§Ú§Þ§Ó§à§Ý§à§Ó
    mv s6 s5                # §²§Ñ§Ù§Þ§Ö§â §Ù§Ñ§á§Ú§ã§Ú §â§Ñ§Ó§Ö§ß N
    j write_to_file        # §±§Ö§â§Ö§Û§ä§Ú §Ü §Ù§Ñ§á§Ú§ã§Ú §Ó §æ§Ñ§Û§Ý

use_full_text:
    mv s6 s4                # §¦§ã§Ý§Ú N > §Õ§Ý§Ú§ß§í §ã§ä§â§à§Ü§Ú, §Ù§Ñ§á§Ú§ã§í§Ó§Ñ§Ö§Þ §Ó§ã§ð §ã§ä§â§à§Ü§å

write_to_file:
    write_addr(s8, s3, s6)     	# §©§Ñ§á§Ú§ã§î §Ó §æ§Ñ§Û§Ý
    
    beqz s7 write_to_console 	# §¦§ã§Ý§Ú s7 == 0, §Ó§í§Ó§à§Õ §Ó §Ü§à§ß§ã§à§Ý§î
    j end_subroutine

write_to_console:
    li t0 1
    write_addr(t0, s3, s6)    # §£§í§Ó§à§Õ §Ó §Ü§à§ß§ã§à§Ý§î (§Õ§Ö§ã§Ü§â§Ú§á§ä§à§â stdout = 1)

end_subroutine:
    pop(ra)
    jr ra                           